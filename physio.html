<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physiotherapist Interface</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #qrcode img { display: block; margin: 20px 0; }
        .treatment-option { margin-bottom: 10px; }
        .treatment-details { margin-left: 25px; }
        .treatment-details input[type="number"] { width: 50px; }
        #scanButton { margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>Physiotherapy Treatment QR Code Generator</h1>
    <p>Today's Date: <span id="currentDate"></span></p>
    <button id="scanButton">Scan Previous QR Code</button>
    <div id="reader" style="width: 300px; height: 300px;"></div>
    <form id="treatmentForm">
        <label for="patientName">Patient Name:</label>
        <input type="text" id="patientName" required><br><br>
        
        <h3>Treatments:</h3>
        <div class="treatment-option">
            <input type="checkbox" id="legPress" name="treatment" value="Leg Press">
            <label for="legPress">Leg Press</label>
            <div class="treatment-details">
                <input type="number" id="legPressSets" placeholder="Sets" min="1">
                <input type="number" id="legPressReps" placeholder="Reps" min="1">
                <input type="number" id="legPressWeight" placeholder="Weight" min="0"> kg
            </div>
        </div>
        
        <div class="treatment-option">
            <input type="checkbox" id="us" name="treatment" value="Ultrasound">
            <label for="us">Ultrasound</label>
            <div class="treatment-details">
                <input type="text" id="usRegion" placeholder="Region">
            </div>
        </div>
        
        <br>
        <button type="submit">Generate QR Code</button>
    </form>
    <div id="qrcode"></div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const currentDateElement = document.getElementById('currentDate');
        const treatmentForm = document.getElementById('treatmentForm');
        const qrcodeElement = document.getElementById('qrcode');
        const scanButton = document.getElementById('scanButton');

        //the below for testing the date
        //function getCurrentDate() {
            // Return a specific date: October 3, 2024
        //    return '2024-10-03';
        //}

        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }

        currentDateElement.textContent = getCurrentDate();

        function populateForm(data) {
            document.getElementById('patientName').value = data.patientName;
            data.treatments.forEach(treatment => {
                if (treatment.name === 'Leg Press') {
                    document.getElementById('legPress').checked = true;
                    document.getElementById('legPressSets').value = treatment.sets;
                    document.getElementById('legPressReps').value = treatment.reps;
                    document.getElementById('legPressWeight').value = treatment.weight;
                } else if (treatment.name === 'Ultrasound') {
                    document.getElementById('us').checked = true;
                    document.getElementById('usRegion').value = treatment.region;
                }
            });
        }

        scanButton.addEventListener('click', function() {
            const html5QrCode = new Html5Qrcode("reader");
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                html5QrCode.stop().then((ignore) => {
                    const hash = new URL(decodedText).hash.substr(1);
                    const decodedData = atob(hash);
                    const data = JSON.parse(decodedData);
                    populateForm(data);
                }).catch((err) => {
                    console.log(err);
                });
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
        });

        treatmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const patientName = document.getElementById('patientName').value;
            const date = getCurrentDate();
            
            let treatments = [];
            
            if (document.getElementById('legPress').checked) {
                treatments.push({
                    name: 'Leg Press',
                    sets: document.getElementById('legPressSets').value,
                    reps: document.getElementById('legPressReps').value,
                    weight: document.getElementById('legPressWeight').value
                });
            }
            
            if (document.getElementById('us').checked) {
                treatments.push({
                    name: 'Ultrasound',
                    region: document.getElementById('usRegion').value
                });
            }
            
            const data = JSON.stringify({patientName, treatments, date});
            const encodedData = btoa(data);
            
            // Update this line with your GitHub Pages URL
            const baseUrl = "https://matthewtse2011.github.io/dspt/";
            const dataUrl = `${baseUrl}patient.html#${encodedData}`;
            
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(dataUrl)}`;
            
            qrcodeElement.innerHTML = `<img src="${qrApiUrl}" alt="QR Code">`;
        });
    </script>
</body>
</html>
