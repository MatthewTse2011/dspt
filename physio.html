<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physiotherapist Interface</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #qrcode img { display: block; margin: 20px 0; }
        .treatment-option { margin-bottom: 10px; }
        .treatment-details { margin-left: 25px; }
        .treatment-details input[type="number"] { width: 50px; }
        #scanButton { margin-bottom: 20px; }
        #reader {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
        }

        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }

        #reader__scan_region {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        #reader__dashboard_section_swaplink {
            display: none !important;
        }
        #reader::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }
        #reader.focusing::before {
            border-color: yellow;
        }
    </style>
</head>
<body>
    <h1>Physiotherapy Treatment QR Code Generator1</h1>
    <p>Today's Date: <span id="currentDate"></span></p>
    <button id="scanButton">Scan Previous QR Code</button>
    <div id="readerContainer" style="display: none;">
        <div id="reader" style="width: 300px; height: 300px; position: relative;"></div>
        <button id="cancelScan">Cancel</button>
    </div>
    <form id="treatmentForm">
        <label for="patientName">Patient Name:</label>
        <input type="text" id="patientName" required><br><br>
        
        <h3>Treatments:</h3>
        <div class="treatment-option">
            <input type="checkbox" id="legPress" name="treatment" value="Leg Press">
            <label for="legPress">Leg Press</label>
            <div class="treatment-details">
                <input type="number" id="legPressSets" placeholder="Sets" min="1">
                <input type="number" id="legPressReps" placeholder="Reps" min="1">
                <input type="number" id="legPressWeight" placeholder="Weight" min="0"> kg
            </div>
        </div>
        
        <div class="treatment-option">
            <input type="checkbox" id="us" name="treatment" value="Ultrasound">
            <label for="us">Ultrasound</label>
            <div class="treatment-details">
                <input type="text" id="usRegion" placeholder="Region">
            </div>
        </div>
        
        <br>
        <button type="submit">Generate QR Code</button>
    </form>

    <div id="qrcode"></div>
    

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
    const currentDateElement = document.getElementById('currentDate');
    const treatmentForm = document.getElementById('treatmentForm');
    const qrcodeElement = document.getElementById('qrcode');
    const scanButton = document.getElementById('scanButton');
    const readerContainer = document.getElementById('readerContainer');
    let html5QrCode;

    function getCurrentDate() {
        const options = {
            timeZone: 'Asia/Hong_Kong',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        };
        const formatter = new Intl.DateTimeFormat('en-HK', options);
        const parts = formatter.formatToParts(new Date());
        const year = parts.find(part => part.type === 'year').value;
        const month = parts.find(part => part.type === 'month').value;
        const day = parts.find(part => part.type === 'day').value;
        return `${year}-${month}-${day}`;
    }

    currentDateElement.textContent = getCurrentDate();

    function populateForm(data) {
        document.getElementById('patientName').value = data.patientName;
        data.treatments.forEach(treatment => {
            if (treatment.name === 'Leg Press') {
                document.getElementById('legPress').checked = true;
                document.getElementById('legPressSets').value = treatment.sets;
                document.getElementById('legPressReps').value = treatment.reps;
                document.getElementById('legPressWeight').value = treatment.weight;
            } else if (treatment.name === 'Ultrasound') {
                document.getElementById('us').checked = true;
                document.getElementById('usRegion').value = treatment.region;
            }
        });
    }

    scanButton.addEventListener('click', function() {
        readerContainer.style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");

        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            const readerElement = document.getElementById('reader');
            readerElement.style.border = '5px solid green';
            setTimeout(() => {
                readerElement.style.border = 'none';
            }, 1000);

            html5QrCode.stop().then((ignore) => {
                const hash = new URL(decodedText).hash.substr(1);
                const decodedData = atob(hash);
                const data = JSON.parse(decodedData);
                populateForm(data);
                readerContainer.style.display = 'none';
            }).catch((err) => {
                console.log(err);
            });
        };

        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            disableFlip: false,
            formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
        };

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            qrCodeSuccessCallback
        ).then(() => {
            console.log("QR Code scanning started");
            setupCloseUpMode();
        }).catch((err) => {
            console.error("Failed to start scanner", err);
            if (err.name === 'NotAllowedError') {
                alert("Camera access was denied. Please check your browser settings and grant camera permissions.");
            } else if (err.name === 'NotFoundError') {
                alert("No camera found on your device.");
            } else {
                alert("Failed to start camera. Error: " + err.message);
            }
            readerContainer.style.display = 'none';
        });
    });

    function setupCloseUpMode() {
        const videoElement = document.querySelector('#reader video');
        if (videoElement) {
            const track = videoElement.srcObject.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            const settings = {};

            if (capabilities.focusMode && capabilities.focusMode.includes('manual')) {
                settings.focusMode = 'manual';
                settings.focusDistance = 20; // Set focus distance to 20cm (close-up)
            }

            if (capabilities.zoom) {
                settings.zoom = capabilities.zoom.max * 0.5; // Set zoom to 50% of max
            }

            track.applyConstraints({ advanced: [settings] })
                .then(() => {
                    console.log("Close-up mode applied successfully");
                    provideVisualFeedback();
                })
                .catch(error => console.error("Could not set close-up mode: ", error));
        } else {
            console.log("Video element not found");
        }
    }

    function provideVisualFeedback() {
        const reader = document.getElementById('reader');
        reader.style.boxShadow = '0 0 0 3px yellow';
        setTimeout(() => {
            reader.style.boxShadow = 'none';
        }, 500);
    }

    document.getElementById('cancelScan').addEventListener('click', function() {
        if (html5QrCode) {
            html5QrCode.stop().then((ignore) => {
                console.log("QR Code scanning stopped.");
                readerContainer.style.display = 'none';
                html5QrCode.clear();
            }).catch((err) => {
                console.log("Failed to stop QR Code scanning.", err);
            });
        } else {
            readerContainer.style.display = 'none';
        }
    });

    treatmentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const patientName = document.getElementById('patientName').value;
        const date = getCurrentDate();
        let treatments = [];

        if (document.getElementById('legPress').checked) {
            treatments.push({
                name: 'Leg Press',
                sets: document.getElementById('legPressSets').value,
                reps: document.getElementById('legPressReps').value,
                weight: document.getElementById('legPressWeight').value
            });
        }

        if (document.getElementById('us').checked) {
            treatments.push({
                name: 'Ultrasound',
                region: document.getElementById('usRegion').value
            });
        }

        const data = JSON.stringify({patientName, treatments, date});
        const encodedData = btoa(data);
        const baseUrl = "https://matthewtse2011.github.io/dspt/";
        const dataUrl = `${baseUrl}patient.html#${encodedData}`;
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(dataUrl)}`;
        qrcodeElement.innerHTML = `<img src="${qrApiUrl}" alt="QR Code">`;
    });
    </script>
</body>
</html>
