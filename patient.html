<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Treatment Information</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto;
            padding: 20px; 
        }
        h2, h3 { 
            color: #333; 
        }
        ul { 
            padding-left: 20px; 
        }
        .treatment {
            background-color: #f9f9f9;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Patient Treatment Information</h1>
    <p>Date(日期): <span id="treatmentDate"></span></p>
    <p>Patient Name(病人姓名): <span id="patientNameDisplay"></span></p>
    <p>Therapist Code/Name(治療師編號/姓名): <span id="therapistNameDisplay"></span></p>
    <div id="treatmentDetails"></div>

    <script>
        function getCurrentDate() {
            const options = {
                timeZone: 'Asia/Hong_Kong',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            };
            const formatter = new Intl.DateTimeFormat('en-HK', options);
            const parts = formatter.formatToParts(new Date());
            const year = parts.find(part => part.type === 'year').value;
            const month = parts.find(part => part.type === 'month').value;
            const day = parts.find(part => part.type === 'day').value;
            return `${year}-${month}-${day}`;
        }

        const treatmentTranslations = {
                'left': '左',
                'right': '右',
                'EMS': '電機',
                    'emsMode': 'Mode',
                    'emsCustomRegion': '自定義區域',
                    //'emsRegion': '區域', 
                    //'emsSubRegion': '子區域',
                'Ultrasound': '超聲波', 
                    'usRegion': '區域', 
                    'usSubRegion': '子區域',
                    'usIntensity': '強度 (w/cm2)',
                    'usDuration': '時間 (分鐘)',
                    'usPulseMode': 'Pulse Mode',
                    'CustomRegion': '自定義區域',
                    'pulseMode': '脈衝模式',
                'Hotpack': '熱敷',
                'MTP': '磁療',
                'Hotmagner': '熱磁機',
                'IFT': '干擾波',
                'Wax': '蠟療',
                'Whirlpool': '水療',
                'region': '區域',
                'subregion': '子區域',
                'duration': '持續時間',
                'mode': '模式',
                'quadriceps': '四頭肌',
                'vmo': '內側斜肌(VMO)',
                'face': '面',
                'calf': '小腿',
                'shoulder': '肩',
                'waist': '腰部',
                'neck': '頸部',
                'back': '腰部',
                'elbow': '手肘',
                'wrist': '手腕',
                'hand': '手',
                'hip': '臀',
                'knee': '膝蓋',
                'ankle': '腳踝',
                'foot': '腳'
        };


        function displayPatientView() {
            const hash = window.location.hash.substr(1);

            if (hash) {
                try {
                    const decodedData = atob(hash);
                    const data = JSON.parse(decodedData);
                    const today = getCurrentDate();

                    if (data.date === today) {
                        document.getElementById('treatmentDate').textContent = data.date;
                        document.getElementById('patientNameDisplay').textContent = data.patientName;
                        document.getElementById('therapistNameDisplay').textContent = data.therapistName;

                        let treatmentHTML = '<h2>Treatments:</h2>';

                        data.treatments.forEach(treatment => {
                            // Translate treatment name if available
                            const treatmentName = treatmentTranslations[treatment.name] || treatment.name;

                            treatmentHTML += `<div class="treatment">`;
                            treatmentHTML += `<h3>${treatmentName} (${treatment.name})</h3>`;  // Display both English and Chinese names

                            treatmentHTML += `<ul>`;

                            // Check if both region and subregion exist
                            //const region = treatment.region ? treatmentTranslations[treatment.region] || treatment.region : '';
                            //const subregion = treatment.subregion ? treatmentTranslations[treatment.subregion] || treatment.subregion : '';

                            //if (region && subregion) {
                                // Combine region and subregion
                            //    treatmentHTML += `<li>區域: ${region}${subregion}</li>`;
                            //}

                            // Iterate through each key-value pair in the treatment, excluding 'region' and 'subregion' since they are combined
                            for (const [key, value] of Object.entries(treatment)) {
                                //if (key !== 'name' && key !== 'region' && key !== 'subregion') {
                                if (key !== 'name') {
                                    // Translate key and value if available
                                    const translatedKey = treatmentTranslations[key] || key;
                                    const translatedValue = treatmentTranslations[value] || value;

                                    const region = treatmentTranslations[treatment.region];
                                    const subregion = treatmentTranslations[treatment.subregion];

                                    //treatmentHTML += `<li>${region}: ${subregion}</li>`;

                                    //if (key == "usRegion") {
                                        // Combine region and subregion
                                        //treatmentHTML += `<p> bye </p>`;
                                        //treatmentHTML += `<p> ${value}</p>`;
                                    //    treatmentHTML += `<li>區域: ${translatedValue}`;
                                    //} else if (key == 'usSubRegion') {
                                    //    treatmentHTML += `${translatedValue}</li>`;
                                    //} else {
                                    //    treatmentHTML += `<li>${translatedKey}: ${translatedValue}</li>`;
                                    //}

                                    if (key.includes("CustomRegion") && translatedValue != ""){
                                        treatmentHTML += `<li>位置: ${translatedValue}</li>`;

                                    } else if (key.includes("SubRegion") && translatedValue != "") {
                                        // Combine region and subregion
                                        //treatmentHTML += `<p> bye </p>`;
                                        //treatmentHTML += `<p> ${value}</p>`;
                                        treatmentHTML += `${translatedValue}</li>`;

                                    } else if (key.includes("Region") && translatedValue != "") {
                                        treatmentHTML += `<li>位置: ${translatedValue}`;

                                    } else if (key.includes("Duration") && translatedValue != "") {
                                        treatmentHTML += `<li>時間 (分鐘): ${translatedValue}</li>`;

                                    } else if (key.includes("PulseMode") && translatedValue == "" ) {
                                        treatmentHTML += ``;

                                    } else if (key.includes("usDeliver") && translatedValue != "") {
                                        treatmentHTML += `<li> ${translatedValue}</li>`;

                                    } else if (key.includes("CustomParameter") && translatedValue != "") {
                                        treatmentHTML += `<li> ${translatedValue}</li>`;

                                    } else if (key.includes("Parameter") && translatedValue != "") {
                                        treatmentHTML += `<li> ${translatedValue}</li>`;

                                    } else if (key.includes("tensModes") && translatedValue != "" ) {
                                        treatmentHTML += `<li> ${translatedValue}</li>`;

                                    } else if (translatedValue != "") {
                                        treatmentHTML += `<li>${translatedKey}: ${translatedValue}</li>`;
                                    }

                                    
                                }
                            }

                            treatmentHTML += `</ul></div>`;
                        });

                        document.getElementById('treatmentDetails').innerHTML = treatmentHTML;
                    } else {
                        alert('This treatment plan has expired.');
                    }
                } catch (e) {
                    console.error("Failed to decode or parse data:", e);
                    alert('Invalid QR code data.');
                }
            } else {
                alert('No treatment data found.');
            }
        }

        window.onload = displayPatientView;
    </script>
</body>
</html>
